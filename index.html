<!doctype html>
<html>
	<head>
		<link href="styles.css" rel="stylesheet" type="text/css" />
		<script src="Phys.js" type="text/javascript"></script>
		<script src="Phys.predict.js" type="text/javascript"></script>
	</head>
	<body>
		<canvas id="view" width="100" height="300" style="border:2px inset";></canvas>
		<div id="controls">
			<button id="relaunch">Relaunch</button>
			Bounce = <span id="bounce-display">0.5</span><br />
			<input id="bounce" type="range" min="0.2" max="1" value="0.5" step="0.01" />
		</div>

		<script type="text/javascript">
			var raf = function() { };
			var raf = requestAnimationFrame;
			
			var view = document.getElementById("view"),
				vctx = view.getContext("2d"),
				vw = view.width, vc = vw/2, vh = view.height;

			var fullCircle = Math.PI * 2, radius = 20, clearPadding = 1;
			var scale = 80, bounce = 0.5, atRest = false;

			var ball = new Phys();
			ball.onGround = vh - radius;
			ball.bounce = 0.5;
			ball.reset = function() {
				var scale = 80;
				ball.position = ball.onGround;
				ball.velocity=-7.5 * 80;
				ball.acceleration = 9.8 * 80;
				
				onGround.next();
				
				vctx.fillStyle="red";
			};
			
			var onGround = {
				next: function() {
					return (onGround.time = Phys.predict.time.byPosition(ball, ball.onGround));
				},
				time: null
			};

			ball.reset();
			
			raf((function(){
				var prevFrame = null,
					nextFrame, deltaFrame, avgFrame = 1/60;
				
				var prevPos;
				var cutOffMovement = 1e-10;
				return function frame(timestamp) {
					if(prevFrame===null){
						prevFrame=timestamp;
					}
					
					nextFrame=timestamp;
					deltaFrame = (nextFrame - prevFrame)/1000;
					prevFrame=nextFrame;

					
					{ // update
						//console.log(onGround.time);
						if(onGround.time!==null){
							if(onGround.time<=deltaFrame){
								var i=0;
								prevPos = ball.position;
								onGround.next();
								while ((onGround.time!==null) && (onGround.time<=deltaFrame)) {
									if(++i>Infinity){
										console.log("stop iterating", i);
										onGround.time = null;
										ball.position = ball.onGround;
										break;
									}
									
									ball.simulate(onGround.time);
									
									/*if (  // short-circuit to prevent long iterations
										(
											prevPos > ball.position
												? prevPos - ball.position
												: ball.position - prevPos
										) < cutOffMovement
									){
										onGround.time = null;
									}
									else{*/
										if(ball.position>ball.onGround){ console.log("overstep", ball.position); }
										//console.log(ball.position, ball.onGround);
										if(ball.position!==ball.onGround){console.log("miss", ball.position);}

										if(i===1){
											ball.velocity = -ball.velocity * ball.bounce;
											if(ball.position!==ball.onGround){
												console.log("inaccurate position", ball.position);
											}
											ball.position = ball.onGround;
										}

										deltaFrame -= onGround.time;
										onGround.next();
									/*}*/
									
									prevPos = ball.position;
								}
								//if(i>1){console.log(i, "iterations");}
							}
						
							if(onGround.time>deltaFrame){
								ball.simulate(deltaFrame);
								ball.previousPosition = ball.position;
								onGround.time-=deltaFrame;
							}
							
							if(onGround.time===null){
								vctx.fillStyle="blue";
							}
						}
					}
					
					{ // render
						vctx.clearRect(0,0,vw,vh);

						vctx.beginPath();
						vctx.arc(vc, ball.position, radius, 0, fullCircle, true);
						vctx.fill();
					}
					
					raf(frame);
				};
			})());

			(function setupBounceInput() {
				var display = document.getElementById("bounce-display");
				
				var input = document.getElementById("bounce");
				input.addEventListener("input", update);
				input.addEventListener("change", update);
				function update() {
					if(ball.bounce!=input.value){
						display.innerText = input.value;
						ball.bounce=+input.value;
						if(onGround.time===null){
							ball.reset();
						}
					}
				}
			})();
			
			document.getElementById("relaunch").addEventListener("click", function(){
				if(onGround.time === null){
					ball.reset();
				}
				else{
					var oldPos = ball.position;
					ball.reset();
					var moveToPosition = Phys.predict.time.byPosition(ball, oldPos);
					ball.simulate(moveToPosition);
					onGround.next();
				}
			});
		</script>
	</body>
</html>